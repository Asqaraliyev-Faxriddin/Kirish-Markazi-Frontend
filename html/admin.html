<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin qo'shish</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <h2>Admin foydalanuvchi qoâ€˜shish</h2>
    <form id="adminForm">
      <input type="text" id="username" placeholder="ğŸ‘¤ Username" required />
      <input type="email" id="email" placeholder="ğŸ“§ Email" required />
      <input type="password" id="password" placeholder="ğŸ”‘ Parol" required />
      <input type="password" id="repeat_password" placeholder="âœ… Parolni tasdiqlang" required />
      <button type="submit">â• Qoâ€˜shish</button>
    </form>
    <p id="result" class="success"></p>
    <p id="error" class="error"></p>
  </div>

  <script>
    const backendURL = "https://kirish-markazi-backend.onrender.com";

    (async () => {
      const token = localStorage.getItem("access_token");
      if (!token) {
        alert("Tizimga kirmagansiz!");
        window.location.href = "login.html";
        return;
      }

      try {
        const res = await fetch(`${backendURL}/api/user/me`, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`
          }
        });

        const data = await res.json();

        if (!res.ok || (data.role !== "ADMIN" && data.role !== "SUPERADMIN")) {
          alert("Sizda admin qoâ€˜shish vakolati yoâ€˜q!");
          window.location.href = "users-panel.html";
        }
      } catch (err) {
        alert("Tizimda nosozlik!");
        window.location.href = "login.html";
      }
    })();

    document.getElementById("adminForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const user = {
        username: document.getElementById("username").value,
        email: document.getElementById("email").value,
        password: document.getElementById("password").value,
        repeat_password: document.getElementById("repeat_password").value
      };

      try {
        const res = await fetch(`${backendURL}/auth/add/admin`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${localStorage.getItem("access_token")}`
          },
          body: JSON.stringify(user)
        });

        const data = await res.json();

        if (!res.ok) {
          document.getElementById("error").innerText = Array.isArray(data.message)
            ? data.message.join("\n")
            : data.message || "Xatolik yuz berdi!";
          document.getElementById("result").innerText = "";
          return;
        }

        document.getElementById("result").innerText = "âœ… Admin muvaffaqiyatli qoâ€˜shildi!";
        document.getElementById("error").innerText = "";
        document.getElementById("adminForm").reset();

        setTimeout(() => {
          window.location.href = "users-panel.html";
        }, 3000);

      } catch (err) {
        document.getElementById("error").innerText = "ğŸŒ Serverga ulanib boâ€˜lmadi!";
        document.getElementById("result").innerText = "";
      }
    });
  </script>
</body>
</html>
